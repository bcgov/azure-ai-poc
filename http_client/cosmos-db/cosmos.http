###############################################################################
# Azure Cosmos DB REST API Client
# Reference: https://learn.microsoft.com/en-us/rest/api/cosmos-db/
#
# AUTHENTICATION SETUP:
# Cosmos DB requires HMAC-SHA256 signature authentication. Use the included
# PowerShell script to generate the Authorization header:
#
#   .\Generate-CosmosAuth.ps1 -Verb GET -ResourceType dbs -ResourceLink ""
#
# The script will output:
#   - x-ms-date: The timestamp (must match Authorization signature)
#   - Authorization: The HMAC-SHA256 signed token
#
# Copy both values and replace the placeholders below before making requests.
#
# EXAMPLES:
#   List databases:     -Verb GET -ResourceType dbs -ResourceLink ""
#   Get database:       -Verb GET -ResourceType dbs -ResourceLink "dbs/MyDB"
#   List containers:    -Verb GET -ResourceType colls -ResourceLink "dbs/MyDB"
#   Get container:      -Verb GET -ResourceType colls -ResourceLink "dbs/MyDB/colls/MyContainer"
#   List documents:     -Verb GET -ResourceType docs -ResourceLink "dbs/MyDB/colls/MyContainer"
#   Create document:    -Verb POST -ResourceType docs -ResourceLink "dbs/MyDB/colls/MyContainer"
#   Query documents:    -Verb POST -ResourceType docs -ResourceLink "dbs/MyDB/colls/MyContainer"
###############################################################################

# Load environment variables from .env file
@baseUrl = {{$dotenv COSMOS_DB_ENDPOINT}}
@masterKey = {{$dotenv COSMOS_DB_KEY}}
@databaseName = {{$dotenv COSMOS_DB_DATABASE_NAME}}
@containerName = {{$dotenv COSMOS_DB_CONTAINER_NAME}}

# API Version
@apiVersion = 2018-12-31

# === GENERATED AUTH VALUES (replace with output from Generate-CosmosAuth.ps1) ===
# Run: .\Generate-CosmosAuth.ps1 -Verb <verb> -ResourceType <type> -ResourceLink "<link>"
@authDate = Thu, 07 Dec 2025 00:00:00 GMT
@authToken = type%3dmaster%26ver%3d1.0%26sig%3dYOUR_SIGNATURE_HERE

###############################################################################
# DATABASE OPERATIONS
# Reference: https://learn.microsoft.com/en-us/rest/api/cosmos-db/databases
###############################################################################

### List Databases
# @name listDatabases
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb GET -ResourceType dbs -ResourceLink ""
GET {{baseUrl}}/dbs
Content-Type: application/json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}
###############################################################################

### Get Database
# @name getDatabase
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb GET -ResourceType dbs -ResourceLink "dbs/{{databaseName}}"
GET {{baseUrl}}/dbs/{{databaseName}}
Content-Type: application/json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}

###############################################################################
# CONTAINER OPERATIONS
# Reference: https://learn.microsoft.com/en-us/rest/api/cosmos-db/collections
###############################################################################

### List Containers in Database
# @name listContainers
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb GET -ResourceType colls -ResourceLink "dbs/{{databaseName}}"
GET {{baseUrl}}/dbs/{{databaseName}}/colls
Content-Type: application/json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}

###############################################################################

### Get Container
# @name getContainer
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb GET -ResourceType colls -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}"
GET {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}
Content-Type: application/json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}

###############################################################################
# DOCUMENT OPERATIONS
# Reference: https://learn.microsoft.com/en-us/rest/api/cosmos-db/documents
###############################################################################

### Create Document (Upsert)
# @name createDocument
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb POST -ResourceType docs -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}"
POST {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/docs
Content-Type: application/json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}
x-ms-documentdb-partitionkey: ["user123"]
x-ms-documentdb-is-upsert: true

{
    "id": "chat-session-001",
    "user_id": "user123",
    "type": "chat_session",
    "title": "Conversation about Azure",
    "created_at": "2024-12-07T10:00:00Z",
    "last_updated": "2024-12-07T10:30:00Z",
    "message_count": 5,
    "messages": [
        {
            "role": "user",
            "content": "What is Azure OpenAI?",
            "timestamp": "2024-12-07T10:00:00Z"
        },
        {
            "role": "assistant",
            "content": "Azure OpenAI is a cloud service that provides access to OpenAI's models.",
            "timestamp": "2024-12-07T10:00:05Z"
        }
    ]
}

###############################################################################

### Get Document by ID
# @name getDocument
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb GET -ResourceType docs -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}/docs/chat-session-001"
GET {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/docs/chat-session-001
Content-Type: application/json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}
x-ms-documentdb-partitionkey: ["user123"]

###############################################################################

### Replace Document
# @name replaceDocument
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb PUT -ResourceType docs -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}/docs/chat-session-001"
PUT {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/docs/chat-session-001
Content-Type: application/json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}
x-ms-documentdb-partitionkey: ["user123"]

{
    "id": "chat-session-001",
    "user_id": "user123",
    "type": "chat_session",
    "title": "Conversation about Azure (Updated)",
    "created_at": "2024-12-07T10:00:00Z",
    "last_updated": "2024-12-07T11:00:00Z",
    "message_count": 6,
    "messages": [
        {
            "role": "user",
            "content": "What is Azure OpenAI?",
            "timestamp": "2024-12-07T10:00:00Z"
        },
        {
            "role": "assistant",
            "content": "Azure OpenAI is a cloud service that provides access to OpenAI's models.",
            "timestamp": "2024-12-07T10:00:05Z"
        },
        {
            "role": "user",
            "content": "How do I use it?",
            "timestamp": "2024-12-07T11:00:00Z"
        }
    ]
}

###############################################################################

### Delete Document
# @name deleteDocument
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb DELETE -ResourceType docs -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}/docs/chat-session-001"
DELETE {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/docs/chat-session-001
Content-Type: application/json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}
x-ms-documentdb-partitionkey: ["user123"]

###############################################################################

### List Documents in Container
# @name listDocuments
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb GET -ResourceType docs -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}"
GET {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/docs
Content-Type: application/json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}
x-ms-max-item-count: 10

###############################################################################
# QUERY OPERATIONS
# Reference: https://learn.microsoft.com/en-us/rest/api/cosmos-db/query-documents
###############################################################################

### Query Documents - All Sessions for User
# @name queryByUser
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb POST -ResourceType docs -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}"
POST {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/docs
Content-Type: application/query+json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}
x-ms-documentdb-isquery: true
x-ms-documentdb-query-enablecrosspartition: true
x-ms-max-item-count: 100

{
    "query": "SELECT * FROM c WHERE c.user_id = @userId AND c.type = @type",
    "parameters": [
        {"name": "@userId", "value": "user123"},
        {"name": "@type", "value": "chat_session"}
    ]
}

###############################################################################

### Query Documents - Recent Sessions
# @name queryRecentSessions
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb POST -ResourceType docs -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}"
POST {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/docs
Content-Type: application/query+json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}
x-ms-documentdb-isquery: true
x-ms-documentdb-query-enablecrosspartition: true
x-ms-max-item-count: 10

{
    "query": "SELECT c.id, c.title, c.last_updated, c.message_count FROM c WHERE c.type = 'chat_session' ORDER BY c.last_updated DESC"
}

###############################################################################

### Query with Aggregation - Count by Type
# @name queryAggregation
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb POST -ResourceType docs -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}"
POST {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/docs
Content-Type: application/query+json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}
x-ms-documentdb-isquery: true
x-ms-documentdb-query-enablecrosspartition: true

{
    "query": "SELECT c.type, COUNT(1) as count FROM c GROUP BY c.type"
}

###############################################################################

### Query - Search in Content
# @name querySearch
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb POST -ResourceType docs -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}"
POST {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/docs
Content-Type: application/query+json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}
x-ms-documentdb-isquery: true
x-ms-documentdb-query-enablecrosspartition: true

{
    "query": "SELECT * FROM c WHERE CONTAINS(c.title, @searchTerm, true)",
    "parameters": [
        {"name": "@searchTerm", "value": "Azure"}
    ]
}

###############################################################################

### Query - Pagination with Continuation
# @name queryWithPagination
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb POST -ResourceType docs -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}"
POST {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/docs
Content-Type: application/query+json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}
x-ms-documentdb-isquery: true
x-ms-documentdb-query-enablecrosspartition: true
x-ms-max-item-count: 5

{
    "query": "SELECT * FROM c ORDER BY c._ts DESC"
}

###############################################################################
# STORED PROCEDURES, TRIGGERS, UDFs
###############################################################################

### List Stored Procedures
# @name listStoredProcedures
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb GET -ResourceType sprocs -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}"
GET {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/sprocs
Content-Type: application/json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}

###############################################################################

### List Triggers
# @name listTriggers
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb GET -ResourceType triggers -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}"
GET {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/triggers
Content-Type: application/json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}

###############################################################################

### List User Defined Functions
# @name listUDFs
# Generate auth: .\Generate-CosmosAuth.ps1 -Verb GET -ResourceType udfs -ResourceLink "dbs/{{databaseName}}/colls/{{containerName}}"
GET {{baseUrl}}/dbs/{{databaseName}}/colls/{{containerName}}/udfs
Content-Type: application/json
x-ms-version: {{apiVersion}}
x-ms-date: {{authDate}}
Authorization: {{authToken}}
